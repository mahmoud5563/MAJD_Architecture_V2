<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ - MAJD Architecture</title>
   <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #014C47;
            --primary-dark: #003a35;
            --secondary-bg: #e6e6e6;
            --text-color: #333;
            --light-text-color: #f4f4f4;
            --border-color: #ddd;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            direction: rtl;
            text-align: right;
        }

        /* Header Styling */
        .header {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .header .user-info {
            display: flex;
            align-items: center;
        }

        .header .user-info span {
            margin-right: 15px;
        }

        .header .logout-button {
            background-color: var(--primary-dark);
            color: var(--light-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .header .logout-button:hover {
            background-color: #002b28;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--light-text-color);
            font-size: 24px;
            cursor: pointer;
        }

        /* Layout Container */
        .main-container {
            display: flex;
            flex: 1;
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 5px;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--light-text-color);
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .sidebar ul li a i {
            margin-left: 10px;
            font-size: 18px;
        }

        .sidebar ul li a:hover,
        .sidebar ul li.active a {
            background-color: var(--primary-dark);
            border-radius: 0 20px 20px 0;
        }

        /* Main Content Area */
        .content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-header h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 28px;
        }

        .details-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            /* Wider for details */
            margin: 0 auto;
            /* Center the container */
        }

        .details-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .details-section h4 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            /* Responsive grid */
            gap: 15px;
        }

        .details-grid p {
            margin: 5px 0;
            font-size: 16px;
        }

        .details-grid p strong {
            color: #555;
            margin-left: 8px;
        }

        .details-full-width {
            margin-top: 15px;
        }

        .details-full-width p {
            margin: 5px 0;
            font-size: 16px;
        }

        .details-full-width p strong {
            color: #555;
            margin-left: 8px;
        }

        .action-button {
            /* Renamed from add-button for clarity in detail pages */
            background-color: var(--primary-color);
            color: #fff;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .action-button.edit {
            background-color: #ffc107;
            color: #333;
        }

        .action-button.delete {
            background-color: #dc3545;
        }

        .action-button:hover {
            background-color: var(--primary-dark);
        }

        .action-button.edit:hover {
            background-color: #e0a800;
        }

        .action-button.delete:hover {
            background-color: #c82333;
        }


        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .details-table th,
        .details-table td {
            padding: 12px 15px;
            border: 1px solid #eee;
            text-align: right;
            font-size: 15px;
        }

        .details-table th {
            background-color: #f0f0f0;
            color: var(--text-color);
            font-weight: bold;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 500px;
            animation-name: animatetop;
            animation-duration: 0.4s;
            text-align: right;
        }

        @keyframes animatetop {
            from {
                top: -300px;
                opacity: 0
            }

            to {
                top: 0;
                opacity: 1
            }
        }

        .close-button {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            margin-left: -10px;
            margin-top: -10px;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .modal-form-group {
            margin-bottom: 15px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 15px;
        }

        .modal-form-group input[type="text"],
        .modal-form-group input[type="number"],
        .modal-form-group input[type="date"],
        .modal-form-group textarea,
        .modal-form-group select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            box-sizing: border-box;
            background-color: #f9f9f9;
        }

        .modal-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-button {
            background-color: var(--primary-color);
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .modal-button.cancel {
            background-color: #6c757d;
        }

        .modal-button:hover {
            background-color: var(--primary-dark);
        }

        .modal-button.cancel:hover {
            background-color: #5a6268;
        }

        .modal-message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            text-align: center;
        }

        .modal-message.error {
            background-color: #ffe6e6;
            color: #cc0000;
            border: 1px solid #cc0000;
        }

        .modal-message.success {
            background-color: #e6ffe6;
            color: #008000;
            border: 1px solid #008000;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header .user-info span {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                height: 100%;
                width: var(--sidebar-width);
                transform: translateX(100%);
                z-index: 999;
                box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
                padding-top: 70px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content-area {
                margin-right: 0;
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 998;
            }

            .overlay.active {
                display: block;
            }

            .details-container {
                padding: 20px;
            }

            .details-grid {
                grid-template-columns: 1fr;
                /* Stack details vertically on small screens */
            }

            .action-button {
                padding: 8px 12px;
                font-size: 14px;
            }

            .details-table th,
            .details-table td {
                padding: 8px 10px;
                font-size: 14px;
            }

            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .modal-content h3 {
                font-size: 20px;
            }

            .modal-button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo">
            MAJD Architecture
        </div>
        <div class="user-info">
            <span id="loggedInUser"></span>
            <button class="logout-button" id="logoutButton">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="main-container">
        <div class="overlay" id="sidebarOverlay"></div>
        <div class="sidebar" id="sidebar">

            <ul>
                <li><a href="/dashboard.html" data-page="dashboard"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="/add-project.html" data-page="add-project"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ©
                        Ù…Ø´Ø±ÙˆØ¹</a></li>
                <li class="active"><a href="/projects.html" data-page="projects"><i class="fas fa-project-diagram"></i>
                        Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a></li>
                <li><a href="/clients.html" data-page="clients"><i class="fas fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
                <li><a href="/contractors.html" data-page="contractors"><i class="fas fa-hard-hat"></i> Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</a>
                </li>
                <li><a href="/add-treasury.html" data-page="add-treasury"><i class="fas fa-cash-register"></i> Ø¥Ø¶Ø§ÙØ©
                        Ø®Ø²ÙŠÙ†Ø©</a></li>
                <li><a href="/treasuries.html" data-page="treasuries"><i class="fas fa-boxes"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</a></li>
                <li><a href="/users.html" data-page="users"><i class="fas fa-user-friends"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</a></li>
                <li><a href="/categories.html" data-page="categories"><i class="fas fa-tags"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</a>
                </li>
                <li><a href="#" id="sidebarLogoutButton"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            </ul>
        </div>

        <div class="content-area" id="contentArea">
            <div class="page-header">
                <h1>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: <span id="projectTitle"></span></h1>
                <div>
                    <button class="action-button edit" id="editProjectBtn"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                        Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                    <button class="action-button delete" id="deleteProjectBtn"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù
                        Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                    <button class="action-button" id="backToProjectsBtn"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                        Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
                </div>
            </div>

            <div class="details-container">
                <div class="details-section">
                    <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h4>
                    <div class="details-grid">
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> <span id="detailProjectName"></span></p>
                        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="detailProjectAddress"></span></p>
                        <p><strong>Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³:</strong> <span id="detailProjectEngineer"></span></p>
                        <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="detailProjectClient"></span></p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</strong> <span id="detailProjectStartDate"></span></p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> <span id="detailProjectEndDate"></span></p>
                        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="detailProjectStatus"></span></p>
                    </div>
                    <div class="details-full-width">
                        <p><strong>Ø§Ù„ÙˆØµÙ:</strong> <span id="detailProjectDescription"></span></p>
                        <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> <span id="detailProjectNotes"></span></p>
                    </div>
                </div>

                <div class="details-section">
                    <h4>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                    <div class="details-grid">
                        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> <span id="summaryTotalRevenue">0.00</span> Ø¬.Ù…</p>
                        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</strong> <span id="summaryTotalExpenses">0.00</span> Ø¬.Ù…</p>
                        <p><strong>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©:</strong> <span id="summaryNetProfitLoss">0.00</span> Ø¬.Ù…</p>
                    </div>
                </div>

                <div class="details-section">
                    <h4>Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</h4>
                    <div class="details-grid">
                        <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span id="contractorAgreedAmount">0.00</span> Ø¬.Ù…
                        </p>
                        <p><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span id="contractorPaidAmount">0.00</span> Ø¬.Ù…</p>
                        <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span id="contractorRemainingAmount">0.00</span> Ø¬.Ù…</p>
                    </div>
                    <button class="action-button" id="addContractAgreementBtn"><i class="fas fa-handshake"></i> Ø¥Ø¶Ø§ÙØ©
                        Ø§ØªÙØ§Ù‚ Ù…Ù‚Ø§ÙˆÙ„</button>
                    <button class="action-button" id="addContractPaymentBtn"><i class="fas fa-money-check-alt"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ù…Ù‚Ø§ÙˆÙ„</button>
                    <button class="action-button" id="showContractorStatementBtn"><i class="fas fa-file-invoice-dollar"></i> ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙˆÙ„</button>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ (Ù„Ù„Ø§ØªÙØ§Ù‚ÙŠØ©)</th>
                                <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</th>
                                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</th>
                                <th>Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©</th>
                                <th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="contractorPaymentsTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</td>
                            </tr>
                        </tbody>
                         <tfoot>
    <tr>
      <td><strong>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</strong></td>
      <td id="contractorPaymentsTotal" colspan="3">0.00</td>
    </tr>
  </tfoot>
                    </table>
                </div>

                <div class="details-section">
                    <h4>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
                    <div class="expense-filters-bar" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px; background: #f8f8f8; padding: 10px 15px; border-radius: 8px; border: 1px solid #eee;">
                        <input type="text" id="expenseSearchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª..." style="padding:7px 12px; border:1px solid #ccc; border-radius:5px; width: 200px; font-size:15px;">
                        <select id="expenseCategoryFilter" style="padding:7px 12px; border:1px solid #ccc; border-radius:5px; font-size:15px; min-width:120px;">
                            <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
                        </select>
                        <select id="expenseTreasuryFilter" style="padding:7px 12px; border:1px solid #ccc; border-radius:5px; font-size:15px; min-width:120px;">
                            <option value="">ÙƒÙ„ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</option>
                        </select>
                        <input type="date" id="expenseDateFrom" style="padding:7px 12px; border:1px solid #ccc; border-radius:5px; font-size:15px;" title="Ù…Ù† ØªØ§Ø±ÙŠØ®">
                        <span style="font-size:18px; color:#888;">-</span>
                        <input type="date" id="expenseDateTo" style="padding:7px 12px; border:1px solid #ccc; border-radius:5px; font-size:15px;" title="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®">
                        <button id="clearExpenseFilters" style="padding:7px 15px; background:#eee; color:#333; border:none; border-radius:5px; font-size:15px; cursor:pointer; transition:background 0.2s;">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
                    </div>
                    <button class="action-button" id="addExpenseBtn"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ø¨Ø§Ø¦Ø¹</th>
                                <th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="projectExpensesTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td>
                            </tr>
                        </tbody>
                         <tfoot>
    <tr>
      <td><strong>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</strong></td>
      <td id="expensesTotal" colspan="3">0.00</td>
    </tr>
  </tfoot>
                    </table>
                </div>

                <div class="details-section">
                    <h4>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4>
                    <button class="action-button" id="addRevenueBtn"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯</button>
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
                                <th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="projectRevenuesTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td>
                            </tr>
                        </tbody>
                         <tfoot>
    <tr>
      <td><strong>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª</strong></td>
      <td id="revenuesTotal" colspan="3">0.00</td>
    </tr>
  </tfoot>
                    </table>
                </div>
                <div class="modal-message" id="pageMessage" style="display: none;"></div>

                <div class="details-buttons"
                    style="display: flex; justify-content: center; gap: 15px; margin-top: 30px;">
                    <button type="button" class="action-button" id="exportProjectExcelBtn" style="display: none;">
                        <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
                    </button>









<script>
document.getElementById('exportProjectExcelBtn').addEventListener('click', function () {
    console.log("âœ… Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø´ØºØ§Ù„");

    const wb = XLSX.utils.book_new();

    // ğŸŸ¦ 1- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    const projectDetailsData = [
        ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'],
        ['Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', document.getElementById('detailProjectName').textContent.trim()],
        ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', document.getElementById('detailProjectAddress').textContent.trim()],
        ['Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³', document.getElementById('detailProjectEngineer').textContent.trim()],
        ['Ø§Ù„Ø¹Ù…ÙŠÙ„', document.getElementById('detailProjectClient').textContent.trim()],
        ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡', document.getElementById('detailProjectStartDate').textContent.trim()],
        ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', document.getElementById('detailProjectEndDate').textContent.trim()],
        ['Ø§Ù„Ø­Ø§Ù„Ø©', document.getElementById('detailProjectStatus').textContent.trim()],
        ['Ø§Ù„ÙˆØµÙ', document.getElementById('detailProjectDescription').textContent.trim()],
        ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª', document.getElementById('detailProjectNotes').textContent.trim()],
    ];
    const projectSheet = XLSX.utils.aoa_to_sheet(projectDetailsData);
    XLSX.utils.book_append_sheet(wb, projectSheet, 'Project_Info');

    // ğŸŸ¦ 2- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    const expensesTable = document.getElementById('projectExpensesTableBody');
    const expensesData = [['Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªØµÙ†ÙŠÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¨Ø§Ø¦Ø¹', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©']];
    let totalExpenses = 0;
    for (let row of expensesTable.rows) {
        if (row.cells.length >= 6) {
            const amount = parseFloat(row.cells[0].textContent.trim()) || 0;
            totalExpenses += amount;

            expensesData.push([
                row.cells[0].textContent.trim(),
                row.cells[1].textContent.trim(),
                row.cells[2].textContent.trim(),
                row.cells[3].textContent.trim(),
                row.cells[4].textContent.trim(),
                row.cells[5].textContent.trim()
            ]);
        }
    }

    // ğŸŸ¦ 3- Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†
    const contractorTable = document.getElementById('contractorPaymentsTableBody');
    const contractorData = [['Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡', 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©', 'Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©', 'Ø§Ù„ÙˆØµÙ']];
    let totalContractorPayments = 0;
    for (let row of contractorTable.rows) {
        if (row.cells.length >= 8) {
            const paidNow = parseFloat(row.cells[5].textContent.trim()) || 0;
            totalContractorPayments += paidNow;

            contractorData.push([
                row.cells[0].textContent.trim(),
                row.cells[1].textContent.trim(),
                row.cells[2].textContent.trim(),
                row.cells[3].textContent.trim(),
                row.cells[4].textContent.trim(),
                row.cells[5].textContent.trim(),
                row.cells[6].textContent.trim(),
                row.cells[7].textContent.trim()
            ]);
        }
    }

    // ğŸ§¾ Ù†Ø¶ÙŠÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø´ÙŠØª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
    expensesData.push(['', '', '', '', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', totalExpenses.toFixed(2) + ' Ø¬.Ù…']);
    expensesData.push(['', '', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:', (totalExpenses + totalContractorPayments).toFixed(2) + ' Ø¬.Ù…']);

    const expensesSheet = XLSX.utils.aoa_to_sheet(expensesData);
    XLSX.utils.book_append_sheet(wb, expensesSheet, 'Expenses');

    // ğŸŸ¦ 4- Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
    const revenueTable = document.getElementById('projectRevenuesTableBody');
    const revenueData = [['Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©']];
    for (let row of revenueTable.rows) {
        if (row.cells.length >= 5) {
            revenueData.push([
                row.cells[0].textContent.trim(),
                row.cells[1].textContent.trim(),
                row.cells[2].textContent.trim(),
                row.cells[3].textContent.trim(),
                row.cells[4].textContent.trim()
            ]);
        }
    }
    revenueData.push(['', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:', document.getElementById('summaryTotalRevenue').textContent.trim()]);
    const revenueSheet = XLSX.utils.aoa_to_sheet(revenueData);
    XLSX.utils.book_append_sheet(wb, revenueSheet, 'Revenues');

    // ğŸŸ¦ 5- Ø´ÙŠØª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†
    contractorData.push(['', '', totalContractorPayments.toFixed(2) + ' Ø¬.Ù…']);
    const contractorSheet = XLSX.utils.aoa_to_sheet(contractorData);
    XLSX.utils.book_append_sheet(wb, contractorSheet, 'Contractor_Payments');

    // ğŸŸ¦ 6- ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©
    const profitLossSheet = XLSX.utils.aoa_to_sheet([
        ['ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©'],
        [document.getElementById('summaryNetProfitLoss').textContent.trim()]
    ]);
    XLSX.utils.book_append_sheet(wb, profitLossSheet, 'Profit_Loss');

    // ğŸŸ¦ 7- Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    const fileName = `${document.getElementById('detailProjectName').textContent.trim().replace(/[:\\/?*[\]]/g, '-')}-ØªÙØ§ØµÙŠÙ„.xlsx`;
    XLSX.writeFile(wb, fileName);
});
</script>












                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Add/Edit Expense, Revenue, Contract Agreement, Contract Payment -->

    <!-- Add/Edit Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="expenseModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
            <form id="expenseForm">
                <input type="hidden" id="expenseProjectId">
                <input type="hidden" id="expenseId">
                <div class="modal-form-group">
                    <label for="expenseAmount">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
                    <input type="number" id="expenseAmount" name="amount" required step="0.01">
                </div>
                <div class="modal-form-group">
                    <label for="expenseDescription">Ø§Ù„ÙˆØµÙ:</label>
                    <textarea id="expenseDescription" name="description"></textarea>
                </div>
                <div class="modal-form-group">
                    <label for="expenseCategory">Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                    <select id="expenseCategory" name="category" required>
                        <option value="">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ</option>
                        <!-- Categories will be loaded here dynamically -->
                    </select>
                </div>
                <div class="modal-form-group">
                    <label for="expenseDate">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="expenseDate" name="date" required>
                </div>
                <div class="modal-form-group">
                    <label for="expenseVendor">Ø§Ù„Ø¨Ø§Ø¦Ø¹:</label>
                    <input type="text" id="expenseVendor" name="vendor">
                </div>
                <div class="modal-form-group">
                    <label for="expenseTreasury">Ø§Ù„Ø®Ø²ÙŠÙ†Ø©/Ø§Ù„Ø¹Ù‡Ø¯Ø©:</label>
                    <select id="expenseTreasury" name="treasury" required>
                        <option value="">Ø§Ø®ØªØ± Ø®Ø²ÙŠÙ†Ø©</option>
                        <!-- Treasuries/Accounts will be loaded here -->
                    </select>
                </div>
                <div class="modal-message" id="expenseModalMessage"></div>
                <div class="modal-buttons">
                    <button type="submit" class="modal-button">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
                    <button type="button" class="modal-button cancel" id="cancelExpenseButton">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Revenue Modal -->
    <div id="revenueModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="revenueModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ±Ø§Ø¯</h3>
            <form id="revenueForm">
                <input type="hidden" id="revenueProjectId">
                <input type="hidden" id="revenueId">
                <div class="modal-form-group">
                    <label for="revenueAmount">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
                    <input type="number" id="revenueAmount" name="amount" required step="0.01">
                </div>
                <div class="modal-form-group">
                    <label for="revenueDescription">Ø§Ù„ÙˆØµÙ:</label>
                    <textarea id="revenueDescription" name="description"></textarea>
                </div>
                <div class="modal-form-group">
                    <label for="revenueDate">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="revenueDate" name="date" required>
                </div>
                <div class="modal-form-group">
                    <label for="revenuePaymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„:</label>
                    <select id="revenuePaymentMethod" name="paymentMethod" required>
                        <option value="">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø©</option>
                        <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
                        <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                    </select>
                </div>
                <div class="modal-form-group">
                    <label for="revenueTreasury">Ø§Ù„Ø®Ø²ÙŠÙ†Ø©/Ø§Ù„Ø¹Ù‡Ø¯Ø©:</label>
                    <select id="revenueTreasury" name="treasury" required>
                        <option value="">Ø§Ø®ØªØ± Ø®Ø²ÙŠÙ†Ø©</option>
                        <!-- Treasuries/Accounts will be loaded here -->
                    </select>
                </div>
                <div class="modal-message" id="revenueModalMessage"></div>
                <div class="modal-buttons">
                    <button type="submit" class="modal-button">Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</button>
                    <button type="button" class="modal-button cancel" id="cancelRevenueButton">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Contract Agreement Modal -->
    <div id="contractAgreementModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Ø¥Ø¶Ø§ÙØ© Ø§ØªÙØ§Ù‚ Ù…Ù‚Ø§ÙˆÙ„</h3>
            <form id="contractAgreementForm">
                <input type="hidden" id="agreementProjectId">
                <div class="modal-form-group">
                    <label for="agreementContractor">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</label>
                    <select id="agreementContractor" name="contractorId" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>
                        <!-- Contractors will be loaded here -->
                    </select>
                </div>
                <div class="modal-form-group">
                    <label for="agreementAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ (Ø¬.Ù…):</label>
                    <input type="number" id="agreementAmount" name="agreedAmount" required step="0.01">
                </div>
                <div class="modal-form-group">
                    <label for="agreementDescription">Ø§Ù„ÙˆØµÙ:</label>
                    <textarea id="agreementDescription" name="description"></textarea>
                </div>
                <div class="modal-message" id="contractAgreementMessage"></div>
                <div class="modal-buttons">
                    <button type="submit" class="modal-button">Ø­ÙØ¸ Ø§Ù„Ø§ØªÙØ§Ù‚</button>
                    <button type="button" class="modal-button cancel" id="cancelContractAgreementButton">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Contract Payment Modal -->
    <div id="contractPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ù…Ù‚Ø§ÙˆÙ„</h3>
            <form id="contractPaymentForm">
                <input type="hidden" id="paymentProjectId">
                <input type="hidden" id="paymentAgreementId">
                <div class="modal-form-group">
                    <label for="paymentContractAgreement">Ø§ØªÙØ§Ù‚ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</label>
                    <select id="paymentContractAgreement" name="contractorAgreementId" required>
                        <option value="">Ø§Ø®ØªØ± Ø§ØªÙØ§Ù‚ Ù…Ù‚Ø§ÙˆÙ„</option>
                        <!-- Contractor agreements for this project will be loaded here -->
                    </select>
                </div>
                <div class="modal-form-group">
                    <label for="paymentAmount">Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© (Ø¬.Ù…):</label>
                    <input type="number" id="paymentAmount" name="amount" required step="0.01">
                </div>
                <div class="modal-form-group">
                    <label for="paymentDescription">Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                    <textarea id="paymentDescription" name="description"></textarea>
                </div>
                <div class="modal-form-group">
                    <label for="paymentDate">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="paymentDate" name="date" required>
                </div>
                <div class="modal-form-group">
                    <label for="paymentTreasury">Ø§Ù„Ø®Ø²ÙŠÙ†Ø©/Ø§Ù„Ø¹Ù‡Ø¯Ø©:</label>
                    <select id="paymentTreasury" name="treasuryId" required>
                        <option value="">Ø§Ø®ØªØ± Ø®Ø²ÙŠÙ†Ø©</option>
                        <!-- Treasuries/Accounts will be loaded here -->
                    </select>
                </div>
                <div class="modal-message" id="contractPaymentMessage"></div>
                <div class="modal-buttons">
                    <button type="submit" class="modal-button">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©</button>
                    <button type="button" class="modal-button cancel" id="cancelContractPaymentButton">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contractor Statement Modal -->
    <div id="contractorStatementModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button">&times;</span>
            <h3>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙˆÙ„</h3>
            <div class="modal-form-group">
                <label for="statementContractorSelect">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</label>
                <select id="statementContractorSelect">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù‡Ù†Ø§ -->
                </select>
            </div>
            <div id="contractorStatementTableContainer">
                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‡Ù†Ø§ -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-button cancel" id="closeContractorStatementBtn">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "http://localhost:3000";
        // Client-side authentication check and redirection
        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            let currentUserRole = '';
            let currentProjectId = null; // To store the ID of the currently viewed project

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const decodedPayload = decodeURIComponent(escape(window.atob(base64)));
                const payload = JSON.parse(decodedPayload);

                const username = payload.user.username || payload.user.id || 'Ù…Ø³ØªØ®Ø¯Ù…';
                const role = payload.user.role || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                currentUserRole = role;

                document.getElementById('loggedInUser').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${username} (${role})`;

                // Client-side authorization based on role for sidebar visibility
                const sidebar = document.getElementById('sidebar');
                const addProjectLink = sidebar.querySelector('[data-page="add-project"]');
                const usersLink = sidebar.querySelector('[data-page="users"]');
                const categoriesLink = sidebar.querySelector('[data-page="categories"]');
                const addTreasuryLink = sidebar.querySelector('[data-page="add-treasury"]');
                const treasuriesLink = sidebar.querySelector('[data-page="treasuries"]');
                const contractorsLink = sidebar.querySelector('[data-page="contractors"]');
                const clientsLink = sidebar.querySelector('[data-page="clients"]');

                if (role === 'Ù…Ù‡Ù†Ø¯Ø³') {
                    // Hide restricted elements for engineer
                    if (addProjectLink) addProjectLink.style.display = 'none';
                    if (usersLink) usersLink.style.display = 'none';
                    if (addTreasuryLink) addTreasuryLink.style.display = 'none';
                    if (contractorsLink) contractorsLink.style.display = 'none';
                    if (clientsLink) clientsLink.style.display = 'none';
                }

                // Set active link in sidebar (for this page)
                const currentPageLink = document.querySelector(`.sidebar ul li a[data-page="projects"]`);
                if (currentPageLink) {
                    currentPageLink.parentElement.classList.add('active');
                }
            } catch (e) {
                console.error("Failed to decode token:", e);
                localStorage.removeItem('token');
                window.location.href = '/';
            }

            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('id');

            if (!currentProjectId) {
                document.getElementById('contentArea').innerHTML = '<h1 style="text-align: center; margin-top: 50px; color: #dc3545;">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</h1><p style="text-align: center;"><button onclick="window.location.href=\'/projects.html\'" style="padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button></p>';
                return;
            }

            // Logout functionality
            const logout = () => {
                localStorage.removeItem('token');
                window.location.href = '/';
            };
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('sidebarLogoutButton').addEventListener('click', logout);

            // Responsive Sidebar Toggle
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                document.body.classList.toggle('sidebar-open');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.classList.remove('sidebar-open');
            });

            // ØªÙ†Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· Ø¹Ù„Ù‰ Ù„ÙŠÙ†Ùƒ
            sidebar.addEventListener('click', (event) => {
                const link = event.target.closest('a');
                if (link && link.href && link.id !== 'sidebarLogoutButton') {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                    // Ù…ÙÙŠØ´ preventDefaultØŒ ÙˆØ³ÙŠØ¨ Ø§Ù„ØªÙ†Ù‚Ù„ ÙŠØ´ØªØºÙ„ Ø¹Ø§Ø¯ÙŠ
                }
            });

            /* --- Project Details Page Logic --- */
            const projectTitleSpan = document.getElementById('projectTitle');
            const detailProjectNameSpan = document.getElementById('detailProjectName');
            const detailProjectAddressSpan = document.getElementById('detailProjectAddress');
            const detailProjectDescriptionSpan = document.getElementById('detailProjectDescription');
            const detailProjectEngineerSpan = document.getElementById('detailProjectEngineer');
            const detailProjectClientSpan = document.getElementById('detailProjectClient');
            const detailProjectStartDateSpan = document.getElementById('detailProjectStartDate');
            const detailProjectEndDateSpan = document.getElementById('detailProjectEndDate');
            const detailProjectStatusSpan = document.getElementById('detailProjectStatus');
            const detailProjectNotesSpan = document.getElementById('detailProjectNotes');
            const projectEngineerSelect = document.getElementById('projectEngineer');



            const summaryTotalRevenueSpan = document.getElementById('summaryTotalRevenue');
            const summaryTotalExpensesSpan = document.getElementById('summaryTotalExpenses');
            const summaryNetProfitLossSpan = document.getElementById('summaryNetProfitLoss');

            const contractorAgreedAmountSpan = document.getElementById('contractorAgreedAmount');
            const contractorPaidAmountSpan = document.getElementById('contractorPaidAmount');
            const contractorRemainingAmountSpan = document.getElementById('contractorRemainingAmount');
            const contractorPaymentsTableBody = document.getElementById('contractorPaymentsTableBody');

            const projectExpensesTableBody = document.getElementById('projectExpensesTableBody');
            const projectRevenuesTableBody = document.getElementById('projectRevenuesTableBody');

            const pageMessage = document.getElementById('pageMessage');
            const backToProjectsBtn = document.getElementById('backToProjectsBtn');
            const editProjectBtn = document.getElementById('editProjectBtn');
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            const exportProjectExcelBtn = document.getElementById('exportProjectExcelBtn');

            // Modals and buttons
            const expenseModal = document.getElementById('expenseModal');
            const revenueModal = document.getElementById('revenueModal');
            const contractAgreementModal = document.getElementById('contractAgreementModal');
            const contractPaymentModal = document.getElementById('contractPaymentModal');

            const addExpenseBtn = document.getElementById('addExpenseBtn');
            const addRevenueBtn = document.getElementById('addRevenueBtn');
            const addContractAgreementBtn = document.getElementById('addContractAgreementBtn');
            const addContractPaymentBtn = document.getElementById('addContractPaymentBtn');

            // Form inputs within modals
            const expenseForm = document.getElementById('expenseForm');
            const expenseProjectIdInput = document.getElementById('expenseProjectId');
            const expenseAmountInput = document.getElementById('expenseAmount');
            const expenseDescriptionInput = document.getElementById('expenseDescription');
            const expenseCategorySelect = document.getElementById('expenseCategory');
            const expenseDateInput = document.getElementById('expenseDate');
            const expenseVendorInput = document.getElementById('expenseVendor');
            const expenseTreasurySelect = document.getElementById('expenseTreasury');
            const expenseModalMessage = document.getElementById('expenseModalMessage');
            const cancelExpenseButton = document.getElementById('cancelExpenseButton');

            const revenueForm = document.getElementById('revenueForm');
            const revenueProjectIdInput = document.getElementById('revenueProjectId');
            const revenueAmountInput = document.getElementById('revenueAmount');
            const revenueDescriptionInput = document.getElementById('revenueDescription');
            const revenueDateInput = document.getElementById('revenueDate');
            const revenuePaymentMethodSelect = document.getElementById('revenuePaymentMethod');
            const revenueTreasurySelect = document.getElementById('revenueTreasury'); // New Treasury for Revenue
            const revenueModalMessage = document.getElementById('revenueModalMessage');
            const cancelRevenueButton = document.getElementById('cancelRevenueButton');

            const contractAgreementForm = document.getElementById('contractAgreementForm');
            const agreementProjectIdInput = document.getElementById('agreementProjectId');
            const agreementContractorSelect = document.getElementById('agreementContractor');
            const agreementAmountInput = document.getElementById('agreementAmount');
            const agreementDescriptionInput = document.getElementById('agreementDescription');
            const contractAgreementMessage = document.getElementById('contractAgreementMessage');
            const cancelContractAgreementButton = document.getElementById('cancelContractAgreementButton');

            const contractPaymentForm = document.getElementById('contractPaymentForm');
            const paymentProjectIdInput = document.getElementById('paymentProjectId');
            const paymentAgreementIdInput = document.getElementById('paymentAgreementId');
            const paymentContractAgreementSelect = document.getElementById('paymentContractAgreement'); // This will hold agreement IDs
            const paymentAmountInput = document.getElementById('paymentAmount');
            const paymentDescriptionInput = document.getElementById('paymentDescription'); // Added description for payment
            const paymentDateInput = document.getElementById('paymentDate');
            const paymentTreasurySelect = document.getElementById('paymentTreasury');
            const contractPaymentMessage = document.getElementById('contractPaymentMessage');
            const cancelContractPaymentButton = document.getElementById('cancelContractPaymentButton');

            // Ø²Ø± ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…Ù‚Ø§ÙˆÙ„
            const showContractorStatementBtn = document.getElementById('showContractorStatementBtn');
            const contractorStatementModal = document.getElementById('contractorStatementModal');
            const closeContractorStatementBtn = document.getElementById('closeContractorStatementBtn');
            const statementContractorSelect = document.getElementById('statementContractorSelect');

            // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§ÙˆÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
            statementContractorSelect.addEventListener('change', async function() {
                const contractorId = this.value;
                const tableContainer = document.getElementById('contractorStatementTableContainer');
                tableContainer.innerHTML = '';
                if (!contractorId) return;
                try {
                    const agreementsResponse = await fetch(`${BASE_URL}/api/contract-agreements/${currentProjectId}`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const agreements = await agreementsResponse.json();
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
                    const contractorAgreements = agreements.filter(ag => ag.contractor && ag.contractor._id === contractorId).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    if (contractorAgreements.length === 0) {
                        tableContainer.innerHTML = '<div style="text-align:center; color:#888; margin:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</div>';
                        return;
                    }
                    const paymentsResponse = await fetch(`${BASE_URL}/api/contract-payments/${currentProjectId}`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const payments = await paymentsResponse.json();
                    const agreementIds = contractorAgreements.map(ag => ag._id);
                    const contractorPayments = payments.filter(pay => agreementIds.includes(pay.contractAgreementId));
                    let html = '';
                    contractorAgreements.forEach((ag, idx) => {
                        const agPayments = contractorPayments.filter(pay => pay.contractAgreementId === ag._id);
                        html += `<div style="border:1px solid #eee; border-radius:8px; margin-bottom:20px; padding:10px; background:#fafbfc;">
                            <div style="margin-bottom:8px; font-weight:bold; color:#1a237e; font-size:17px;">${ag.description || 'Ø§ØªÙØ§Ù‚ÙŠØ© Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'} (${idx+1})</div>
                            <div style="margin-bottom:8px;">
                                <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡:</strong> <span>${ag.agreedAmount.toFixed(2)} Ø¬.Ù…</span>
                            </div>`;
                        if (agPayments.length > 0) {
                            html += `<div style="overflow-x:auto;"><table class="details-table" style="margin-top:10px; min-width:500px;">
                                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</th><th>Ø§Ù„ÙˆØµÙ</th></tr></thead><tbody>`;
                            agPayments.forEach(pay => {
                                html += `<tr>
                                    <td>${formatDate(pay.date)}</td>
                                    <td>${pay.amount.toFixed(2)} Ø¬.Ù…</td>
                                    <td>${pay.treasury || '-'}</td>
                                    <td>${pay.description || '-'}</td>
                                </tr>`;
                            });
                            html += '</tbody></table></div>';
                        } else {
                            html += '<div style="color:#888; margin:10px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©.</div>';
                        }
                        html += `<div style="margin-top:8px;"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©:</strong> <span>${(ag.agreedAmount - (ag.paidAmount || 0)).toFixed(2)} Ø¬.Ù…</span></div>`;
                        html += '</div>';
                    });
                    // Ø²Ø± ØªØµØ¯ÙŠØ± Excel
                    html += '<div style="text-align:left; margin-top:20px;"><button id="exportContractorStatementExcelBtn" class="action-button"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Excel</button></div>';
                    tableContainer.innerHTML = html;
                    // ÙƒÙˆØ¯ Ø§Ù„ØªØµØ¯ÙŠØ±
                    document.getElementById('exportContractorStatementExcelBtn').onclick = function() {
                        const wb = XLSX.utils.book_new();
                        contractorAgreements.forEach((ag, idx) => {
                            const agPayments = contractorPayments.filter(pay => pay.contractAgreementId === ag._id);
                            const sheetData = [];
                            sheetData.push([`Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©: ${(ag.description || 'Ø§ØªÙØ§Ù‚ÙŠØ© Ø¨Ø¯ÙˆÙ† ÙˆØµÙ')} (${idx+1})`]);
                            sheetData.push(['Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡', ag.agreedAmount.toFixed(2) + ' Ø¬.Ù…']);
                            sheetData.push(['Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©', (ag.agreedAmount - (ag.paidAmount || 0)).toFixed(2) + ' Ø¬.Ù…']);
                            sheetData.push([]);
                            sheetData.push(['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©', 'Ø§Ù„ÙˆØµÙ']);
                            if (agPayments.length > 0) {
                                agPayments.forEach(pay => {
                                    sheetData.push([
                                        formatDate(pay.date),
                                        pay.amount.toFixed(2) + ' Ø¬.Ù…',
                                        pay.treasury || '-',
                                        pay.description || '-'
                                    ]);
                                });
                            } else {
                                sheetData.push(['Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©']);
                            }
                            const sheet = XLSX.utils.aoa_to_sheet(sheetData);
                            XLSX.utils.book_append_sheet(wb, sheet, `Ø§ØªÙØ§Ù‚ÙŠØ©${idx+1}`);
                        });
                        XLSX.writeFile(wb, 'ÙƒØ´Ù_Ø­Ø³Ø§Ø¨_Ù…Ù‚Ø§ÙˆÙ„.xlsx');
                    };
                } catch (error) {
                    tableContainer.innerHTML = '<div style="text-align:center; color:red; margin:20px;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨.</div>';
                }
            });

            // ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            closeContractorStatementBtn.addEventListener('click', () => {
                contractorStatementModal.style.display = 'none';
            });
            // ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            contractorStatementModal.querySelector('.close-button').addEventListener('click', () => {
                contractorStatementModal.style.display = 'none';
            });

            // Helper function to format dates
            const formatDate = (dateString) => {
                if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                return new Date(dateString).toLocaleDateString('ar-EG');
            };

            // Helper function to populate dropdowns
            async function populateDropdown(selectElement, apiUrl, valueKey, textKey, defaultOptionText = 'Ø§Ø®ØªØ±', customFilter = null, customTextFormatter = null) {
                selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
                try {
                    const response = await fetch(apiUrl, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    if (response.ok) {
                        let items = await response.json();
                        if (customFilter && typeof customFilter === 'function') {
                            items = items.filter(customFilter);
                        }
                        items.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item[valueKey];
                            option.textContent = customTextFormatter ? customTextFormatter(item) : item[textKey];
                            selectElement.appendChild(option);
                        });
                    } else {
                        console.error(`Failed to fetch items from ${apiUrl}:`, await response.json());
                    }
                } catch (error) {
                    console.error(`Error fetching items from ${apiUrl}:`, error);
                }
            }

            // Function to fetch and display project details and related financial data
            const fetchProjectDetails = async () => {
                pageMessage.style.display = 'none';
                projectTitleSpan.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

                // Fetch project details
                try {
                    const projectResponse = await fetch(`${BASE_URL}/api/projects/${currentProjectId}/details`, { // Use details endpoint for summary
                        headers: {
                            'x-auth-token': localStorage.getItem('token')
                        }
                    });
                    const projectData = await projectResponse.json();
                    document.getElementById('exportProjectExcelBtn').style.display = 'inline-block';


                    if (projectResponse.ok) {
                        projectTitleSpan.textContent = projectData.projectName;
                        detailProjectNameSpan.textContent = projectData.projectName;
                        detailProjectAddressSpan.textContent = projectData.address;
                        detailProjectDescriptionSpan.textContent = projectData.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.';
                        detailProjectEngineerSpan.textContent = projectData.engineer ? projectData.engineer.username : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        detailProjectClientSpan.textContent = projectData.client ? projectData.client.clientName : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        detailProjectStartDateSpan.textContent = formatDate(projectData.startDate);
                        detailProjectEndDateSpan.textContent = formatDate(projectData.endDate);
                        detailProjectStatusSpan.textContent = projectData.status;
                        detailProjectNotesSpan.textContent = projectData.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.';

                        // Populate financial summary (now from backend calculated values)
                        summaryTotalRevenueSpan.textContent = (projectData.totalRevenue || 0).toFixed(2) + ' Ø¬.Ù…';
                        summaryTotalExpensesSpan.textContent = (projectData.totalExpenses || 0).toFixed(2) + ' Ø¬.Ù…';
                        summaryNetProfitLossSpan.textContent = (projectData.netProfitLoss || 0).toFixed(2) + ' Ø¬.Ù…';

                        contractorAgreedAmountSpan.textContent = (projectData.totalAgreedContractorAmount || 0).toFixed(2) + ' Ø¬.Ù…';
                        contractorPaidAmountSpan.textContent = (projectData.totalPaidContractorAmount || 0).toFixed(2) + ' Ø¬.Ù…';
                        contractorRemainingAmountSpan.textContent = (projectData.totalRemainingContractorAmount || 0).toFixed(2) + ' Ø¬.Ù…';

                    } else {
                        pageMessage.className = 'modal-message error';
                        pageMessage.textContent = projectData.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                        pageMessage.style.display = 'block';
                        return; // Stop if project details fail
                    }
                } catch (error) {
                    console.error('Error fetching project details:', error);
                    pageMessage.className = 'modal-message error';
                    pageMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                    pageMessage.style.display = 'block';
                    return; // Stop if project details fail
                }

                // Fetch Expenses for this project
                try {
                    const expensesResponse = await fetch(`${BASE_URL}/api/transactions?project=${currentProjectId}&type=Ù…ØµØ±ÙˆÙ`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const expenses = await expensesResponse.json();
                    document.getElementById('exportProjectExcelBtn').style.display = 'inline-block';

                    projectExpensesTableBody.innerHTML = '';
                    if (expenses.length > 0) {
                        let totalExpenses = 0;
                        expenses.forEach(exp => {
                            const row = projectExpensesTableBody.insertRow();
                            row.innerHTML = `
                                <td>${exp.amount.toFixed(2)} Ø¬.Ù…</td>
                                <td>${exp.description || '-'}</td>
                                <td>${exp.category ? exp.category.name : '-'}</td>
                                <td>${formatDate(exp.date)}</td>
                                <td>${exp.vendor || '-'}</td>
                                <td>${exp.treasury ? exp.treasury.name : '-'}</td>
                                <td class="action-buttons">
                                    <button class="delete-expense" data-id="${exp._id}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
                                </td>
                            `;
                            let amount = parseFloat(exp.amount);
                            if (!isNaN(amount)) {
                                totalExpenses += amount;
                            }
                        });
                        document.getElementById('expensesTotal').textContent = totalExpenses.toFixed(2) + ' Ø¬.Ù…';
                    } else {
                        projectExpensesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</td></tr>';
                        document.getElementById('expensesTotal').textContent = '0.00 Ø¬.Ù…';
                    }
                } catch (error) {
                    console.error('Error fetching project expenses:', error);
                    projectExpensesTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.</td></tr>';
                }

                // Fetch Revenues for this project
                try {
                    const revenuesResponse = await fetch(`${BASE_URL}/api/transactions?project=${currentProjectId}&type=Ø¥ÙŠØ¯Ø§Ø¹`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const revenues = await revenuesResponse.json();
                    document.getElementById('exportProjectExcelBtn').style.display = 'inline-block';

                    projectRevenuesTableBody.innerHTML = '';
                    if (revenues.length > 0) {
                        let totalRevenues = 0;
                        revenues.forEach(rev => {
                            const row = projectRevenuesTableBody.insertRow();
                            row.innerHTML = `
                                <td>${rev.amount.toFixed(2)} Ø¬.Ù…</td>
                                <td>${rev.description || '-'}</td>
                                <td>${formatDate(rev.date)}</td>
                                <td>${rev.paymentMethod || '-'}</td>
                                <td>${rev.treasury ? rev.treasury.name : '-'}</td>
                                <td class="action-buttons">
                                    <button class="delete-revenue" data-id="${rev._id}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
                                </td>
                            `;
                            let amount = parseFloat(rev.amount);
                            if (!isNaN(amount)) {
                                totalRevenues += amount;
                            }
                        });
                        document.getElementById('revenuesTotal').textContent = totalRevenues.toFixed(2) + ' Ø¬.Ù…';
                    } else {
                        projectRevenuesTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</td></tr>';
                        document.getElementById('revenuesTotal').textContent = '0.00 Ø¬.Ù…';
                    }
                } catch (error) {
                    console.error('Error fetching project revenues:', error);
                    projectRevenuesTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª.</td></tr>';
                }

                // Fetch Contractor Payments for this project
                try {
                    const contractorPaymentsResponse = await fetch(`${BASE_URL}/api/contract-payments/${currentProjectId}`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const payments = await contractorPaymentsResponse.json();
                    document.getElementById('exportProjectExcelBtn').style.display = 'inline-block';

                    contractorPaymentsTableBody.innerHTML = '';
                    if (payments.length > 0) {
                        let totalContractorPayments = 0;
                        payments.forEach(pay => {
                            const row = contractorPaymentsTableBody.insertRow();
                            row.innerHTML = `
                                <td>${pay.contractorName || '-'}</td>
                                <td>${pay.agreedAmount.toFixed(2)}</td>
                                <td>${pay.paidAmount.toFixed(2)}</td>
                                <td>${(pay.agreedAmount - pay.paidAmount).toFixed(2)}</td>
                                <td>${formatDate(pay.date)}</td>
                                <td>${pay.amount.toFixed(2)}</td>
                                <td>${pay.treasury || '-'}</td>
                                <td>${pay.description || '-'}</td>
                                <td class="action-buttons">
                                    <button class="delete-contract-payment" data-id="${pay._id}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
                                </td>
                            `;
                            let amount = parseFloat(pay.amount);
                            if (!isNaN(amount)) {
                                totalContractorPayments += amount;
                            }
                        });
                        document.getElementById('contractorPaymentsTotal').textContent = totalContractorPayments.toFixed(2) + ' Ø¬.Ù…';
                    } else {
                        contractorPaymentsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</td></tr>';
                        document.getElementById('contractorPaymentsTotal').textContent = '0.00 Ø¬.Ù…';
                    }
                } catch (error) {
                    console.error('Error fetching contractor payments:', error);
                    contractorPaymentsTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†.</td></tr>';
                }
            };

            // Initial fetch on page load
            fetchProjectDetails();

            // Back to projects button
            backToProjectsBtn.addEventListener('click', () => {
                window.location.href = '/projects.html';
            });

            // Edit Project Button (redirect to add-project page with ID)
            editProjectBtn.addEventListener('click', () => {
                window.location.href = `/add-project.html?id=${currentProjectId}`; // Reuse add-project for editing
            });

            // Delete Project Button
            deleteProjectBtn.addEventListener('click', async () => {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                    try {
                        const response = await fetch(`${BASE_URL}/api/projects/${currentProjectId}`, {
                            method: 'DELETE',
                            headers: {
                                'x-auth-token': localStorage.getItem('token')
                            }
                        });
                        const data = await response.json();

                        if (response.ok) {
                            pageMessage.className = 'modal-message success';
                            pageMessage.textContent = data.message;
                            pageMessage.style.display = 'block';
                            setTimeout(() => {
                                window.location.href = '/projects.html'; // Redirect after successful deletion
                            }, 1500);
                        } else {
                            pageMessage.className = 'modal-message error';
                            pageMessage.textContent = data.message || 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                            pageMessage.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('Error deleting project:', error);
                        pageMessage.className = 'modal-message error';
                        pageMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                        pageMessage.style.display = 'block';
                    }
                }
            });


            // General function to close modals
            function setupModalCloseListeners(modalElement, cancelButton) {
                modalElement.querySelector('.close-button').addEventListener('click', () => {
                    modalElement.style.display = 'none';
                    // Reset message div inside modal
                    const modalMessageDiv = modalElement.querySelector('.modal-message');
                    if (modalMessageDiv) {
                        modalMessageDiv.style.display = 'none';
                    }
                });
                if (cancelButton) {
                    cancelButton.addEventListener('click', () => {
                        modalElement.style.display = 'none';
                        const modalMessageDiv = modalElement.querySelector('.modal-message');
                        if (modalMessageDiv) {
                            modalMessageDiv.style.display = 'none';
                        }
                    });
                }
                window.addEventListener('click', (event) => {
                    if (event.target === modalElement) {
                        modalElement.style.display = 'none';
                        const modalMessageDiv = modalElement.querySelector('.modal-message');
                        if (modalMessageDiv) {
                            modalMessageDiv.style.display = 'none';
                        }
                    }
                });
            }

            // Setup listeners for all modals
            setupModalCloseListeners(expenseModal, cancelExpenseButton);
            setupModalCloseListeners(revenueModal, cancelRevenueButton);
            setupModalCloseListeners(contractAgreementModal, cancelContractAgreementButton);
            setupModalCloseListeners(contractPaymentModal, cancelContractPaymentButton);


            // Open Expense Modal
            addExpenseBtn.addEventListener('click', async () => {
                expenseModal.style.display = 'flex';
                expenseForm.reset();
                expenseProjectIdInput.value = currentProjectId;
                expenseDateInput.valueAsDate = new Date(); // Set current date
                await populateDropdown(expenseCategorySelect, '/api/categories', '_id', 'name', 'Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ');
                await populateDropdown(expenseTreasurySelect, '/api/treasuries', '_id', 'name', 'Ø§Ø®ØªØ± Ø®Ø²ÙŠÙ†Ø©');
            });

            // Open Revenue Modal
            addRevenueBtn.addEventListener('click', async () => {
                revenueModal.style.display = 'flex';
                revenueForm.reset();
                revenueProjectIdInput.value = currentProjectId;
                revenueDateInput.valueAsDate = new Date(); // Set current date
                await populateDropdown(revenueTreasurySelect, '/api/treasuries', '_id', 'name', 'Ø§Ø®ØªØ± Ø®Ø²ÙŠÙ†Ø©'); // Populate treasury
            });

            // Open Contract Agreement Modal
            addContractAgreementBtn.addEventListener('click', async () => {
                contractAgreementModal.style.display = 'flex';
                contractAgreementForm.reset();
                agreementProjectIdInput.value = currentProjectId;
                await populateDropdown(agreementContractorSelect, '/api/contractors', '_id', 'contractorName', 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„');
            });

            // Open Contract Payment Modal
            addContractPaymentBtn.addEventListener('click', async () => {
                contractPaymentModal.style.display = 'flex';
                contractPaymentForm.reset();
                paymentProjectIdInput.value = currentProjectId;
                paymentDateInput.valueAsDate = new Date(); // Set current date

                // Populate contractor agreements for this project
                await populateDropdown(
                    paymentContractAgreementSelect,
                    `/api/contract-agreements/${currentProjectId}`,
                    '_id',
                    'description',
                    'Ø§Ø®ØªØ± Ø§ØªÙØ§Ù‚ Ù…Ù‚Ø§ÙˆÙ„',
                    null, // No custom filter
                    (item) => `${item.contractor.contractorName || 'Ù…Ù‚Ø§ÙˆÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} - ${item.description || 'Ø§ØªÙØ§Ù‚ÙŠØ© Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'} (Ø§Ù„Ù…Ø¨Ù„Øº: ${item.agreedAmount.toFixed(2)} Ø¬.Ù…, Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${item.paidAmount.toFixed(2)} Ø¬.Ù…)` // Custom text display
                );

                await populateDropdown(paymentTreasurySelect, '/api/treasuries', '_id', 'name', 'Ø§Ø®ØªØ± Ø®Ø²ÙŠÙ†Ø©');
            });

            // Handle Expense Form Submission

            expenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const transactionData = {
                    project: new URLSearchParams(window.location.search).get('id'),
                    type: 'Ù…ØµØ±ÙˆÙ', // Fixed type for expense (withdrawal)
                    amount: parseFloat(expenseAmountInput.value),
                    description: expenseDescriptionInput.value || undefined,
                    category: expenseCategorySelect.value || undefined,
                    date: expenseDateInput.value,
                    vendor: expenseVendorInput.value || undefined,
                    treasury: expenseTreasurySelect.value // Treasury is required for transaction
                };

                Object.keys(transactionData).forEach(key => {
                    if (transactionData[key] === undefined) {
                        delete transactionData[key];
                    }
                });

                try {
                    const response = await fetch(`${BASE_URL}/api/transactions`, { // Use existing transactions API
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': localStorage.getItem('token')
                        },
                        body: JSON.stringify(transactionData)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        expenseModalMessage.className = 'modal-message success';
                        expenseModalMessage.textContent = data.message || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­.';
                        expenseModalMessage.style.display = 'block';
                        fetchProjectDetails(); // Refresh project details and tables
                        setTimeout(() => expenseModal.style.display = 'none', 1500);
                    } else {
                        expenseModalMessage.className = 'modal-message error';
                        expenseModalMessage.textContent = data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ.';
                        expenseModalMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error saving expense:', error);
                    expenseModalMessage.className = 'modal-message error';
                    expenseModalMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
                    expenseModalMessage.style.display = 'block';
                }
            });

            // Handle Revenue Form Submission
            revenueForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const transactionData = {
                    project: revenueProjectIdInput.value,
                    type: 'Ø¥ÙŠØ¯Ø§Ø¹', // Fixed type for revenue (deposit)
                    amount: parseFloat(revenueAmountInput.value),
                    description: revenueDescriptionInput.value || undefined,
                    date: revenueDateInput.value,
                    paymentMethod: revenuePaymentMethodSelect.value,
                    treasury: revenueTreasurySelect.value // Treasury is required for transaction
                };

                Object.keys(transactionData).forEach(key => {
                    if (transactionData[key] === undefined) {
                        delete transactionData[key];
                    }
                });

                try {
                    const response = await fetch(`${BASE_URL}/api/transactions`, { // Use existing transactions API
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': localStorage.getItem('token')
                        },
                        body: JSON.stringify(transactionData)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        revenueModalMessage.className = 'modal-message success';
                        revenueModalMessage.textContent = data.message || 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.';
                        revenueModalMessage.style.display = 'block';
                        fetchProjectDetails(); // Refresh project details and tables
                        setTimeout(() => revenueModal.style.display = 'none', 1500);
                    } else {
                        revenueModalMessage.className = 'modal-message error';
                        revenueModalMessage.textContent = data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯.';
                        revenueModalMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error saving revenue:', error);
                    revenueModalMessage.className = 'modal-message error';
                    revenueModalMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
                    revenueModalMessage.style.display = 'block';
                }
            });

            // Handle Contract Agreement Form Submission
            contractAgreementForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const agreementData = {
                    project: agreementProjectIdInput.value,
                    contractor: agreementContractorSelect.value,
                    agreedAmount: parseFloat(agreementAmountInput.value),
                    description: agreementDescriptionInput.value || undefined
                };

                Object.keys(agreementData).forEach(key => {
                    if (agreementData[key] === undefined) {
                        delete agreementData[key];
                    }
                });

                try {
                    const response = await fetch(`${BASE_URL}/api/contract-agreements`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': localStorage.getItem('token')
                        },
                        body: JSON.stringify(agreementData)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        contractAgreementMessage.className = 'modal-message success';
                        contractAgreementMessage.textContent = data.message || 'ØªÙ… Ø­ÙØ¸ Ø§ØªÙØ§Ù‚ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.';
                        contractAgreementMessage.style.display = 'block';
                        fetchProjectDetails(); // Refresh project details and tables
                        setTimeout(() => contractAgreementModal.style.display = 'none', 1500);
                    } else {
                        contractAgreementMessage.className = 'modal-message error';
                        contractAgreementMessage.textContent = data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§ØªÙØ§Ù‚ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.';
                        contractAgreementMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error saving contract agreement:', error);
                    contractAgreementMessage.className = 'modal-message error';
                    contractAgreementMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
                    contractAgreementMessage.style.display = 'block';
                }
            });

            // Handle Contract Payment Form Submission
            contractPaymentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const paymentData = {
                    contractAgreementId: paymentContractAgreementSelect.value,
                    amount: parseFloat(paymentAmountInput.value),
                    date: paymentDateInput.value,
                    treasuryId: paymentTreasurySelect.value,
                    description: paymentDescriptionInput.value || undefined // Include description
                };

                Object.keys(paymentData).forEach(key => {
                    if (paymentData[key] === undefined) {
                        delete paymentData[key];
                    }
                });

                try {
                    const response = await fetch(`${BASE_URL}/api/contract-payments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': localStorage.getItem('token')
                        },
                        body: JSON.stringify(paymentData)
                    });
                    const data = await response.json();
                    document.getElementById('exportProjectExcelBtn').style.display = 'inline-block';


                    if (response.ok) {
                        contractPaymentMessage.className = 'modal-message success';
                        contractPaymentMessage.textContent = data.message || 'ØªÙ… Ø­ÙØ¸ Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.';
                        contractPaymentMessage.style.display = 'block';
                        fetchProjectDetails(); // Refresh project details and tables
                        setTimeout(() => contractPaymentModal.style.display = 'none', 1500);
                    } else {
                        contractPaymentMessage.className = 'modal-message error';
                        contractPaymentMessage.textContent = data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.';
                        contractPaymentMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error saving contract payment:', error);
                    contractPaymentMessage.className = 'modal-message error';
                    contractPaymentMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
                    contractPaymentMessage.style.display = 'block';
                }
            });

            // Handle Delete buttons for Expenses, Revenues, and Contract Payments
            document.addEventListener('click', async (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                const transactionId = target.dataset.id;

                // Determine the action based on the button's class
                let deleteApiUrl = '';
                let confirmationMessage = '';
                let successMessage = '';
                let errorMessage = '';

                if (target.classList.contains('delete-expense')) {
                    deleteApiUrl = `/api/transactions/${transactionId}`;
                    confirmationMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                    successMessage = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­.';
                    errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ.';
                } else if (target.classList.contains('delete-revenue')) {
                    deleteApiUrl = `/api/transactions/${transactionId}`;
                    confirmationMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                    successMessage = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.';
                    errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯.';
                } else if (target.classList.contains('delete-contract-payment')) {
                    deleteApiUrl = `/api/contract-payments/${transactionId}`;
                    confirmationMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù‡Ø°Ù‡ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ ØªØ£Ø«ÙŠØ±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§ØªÙØ§Ù‚ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙˆØ§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¹.';
                    successMessage = 'ØªÙ… Ø­Ø°Ù Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.';
                    errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.';
                } else {
                    return; // Not a delete button for these sections
                }

                if (confirm(confirmationMessage)) {
                    try {
                        const response = await fetch(deleteApiUrl, {
                            method: 'DELETE',
                            headers: {
                                'x-auth-token': localStorage.getItem('token')
                            }
                        });
                        const data = await response.json();

                        if (response.ok) {
                            pageMessage.className = 'modal-message success';
                            pageMessage.textContent = data.message || successMessage;
                            pageMessage.style.display = 'block';
                            fetchProjectDetails(); // Refresh project details and tables
                            setTimeout(() => pageMessage.style.display = 'none', 3000);
                        } else {
                            pageMessage.className = 'modal-message error';
                            pageMessage.textContent = data.message || errorMessage;
                            pageMessage.style.display = 'block';
                            setTimeout(() => pageMessage.style.display = 'none', 3000);
                        }
                    } catch (error) {
                        console.error(`Error deleting item from ${deleteApiUrl}:`, error);
                        pageMessage.className = 'modal-message error';
                        pageMessage.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.';
                        pageMessage.style.display = 'block';
                        setTimeout(() => pageMessage.style.display = 'none', 3000);
                    }
                }


            });

            // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
            showContractorStatementBtn.addEventListener('click', async () => {
                contractorStatementModal.style.display = 'flex';
                // ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹
                statementContractorSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</option>';
                // Ø¬Ù„Ø¨ Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                try {
                    const response = await fetch(`${BASE_URL}/api/contract-agreements/${currentProjectId}`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const agreements = await response.json();
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
                    const uniqueContractors = {};
                    agreements.forEach(ag => {
                        if (ag.contractor && ag.contractor._id && !uniqueContractors[ag.contractor._id]) {
                            uniqueContractors[ag.contractor._id] = ag.contractor;
                        }
                    });
                    Object.values(uniqueContractors).forEach(contractor => {
                        const option = document.createElement('option');
                        option.value = contractor._id;
                        option.textContent = contractor.contractorName; // Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø±ØµÙŠØ¯
                        statementContractorSelect.appendChild(option);
                    });
                } catch (error) {
                    statementContractorSelect.innerHTML = '<option value="">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>';
                }
                // Ø¥ÙØ±Ø§Øº ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ÙƒÙ„ ÙØªØ­
                document.getElementById('contractorStatementTableContainer').innerHTML = '';
            });

            // Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Excel
            const expensesTable = document.getElementById('projectExpensesTableBody');
            const expensesExportBtn = document.createElement('button');
            expensesExportBtn.className = 'action-button';
            expensesExportBtn.style.margin = '10px 0 0 0';
            expensesExportBtn.innerHTML = '<i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Excel';
            expensesTable.parentElement.parentElement.insertBefore(expensesExportBtn, expensesTable.parentElement.nextSibling);
            expensesExportBtn.addEventListener('click', function () {
                const expensesData = [['Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªØµÙ†ÙŠÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¨Ø§Ø¦Ø¹', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©']];
                let total = 0;
                for (let row of expensesTable.rows) {
                    if (row.cells.length >= 6) {
                        const amount = parseFloat(row.cells[0].textContent.trim()) || 0;
                        total += amount;
                        expensesData.push([
                            row.cells[0].textContent.trim(),
                            row.cells[1].textContent.trim(),
                            row.cells[2].textContent.trim(),
                            row.cells[3].textContent.trim(),
                            row.cells[4].textContent.trim(),
                            row.cells[5].textContent.trim()
                        ]);
                    }
                }
                expensesData.push(['', '', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:', total.toFixed(2) + ' Ø¬.Ù…']);
                const wb = XLSX.utils.book_new();
                const sheet = XLSX.utils.aoa_to_sheet(expensesData);
                XLSX.utils.book_append_sheet(wb, sheet, 'Expenses');
                XLSX.writeFile(wb, 'Ù…ØµØ±ÙˆÙØ§Øª_Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.xlsx');
            });
            // Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Excel
            const revenueTable = document.getElementById('projectRevenuesTableBody');
            const revenuesExportBtn = document.createElement('button');
            revenuesExportBtn.className = 'action-button';
            revenuesExportBtn.style.margin = '10px 0 0 0';
            revenuesExportBtn.innerHTML = '<i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Excel';
            revenueTable.parentElement.parentElement.insertBefore(revenuesExportBtn, revenueTable.parentElement.nextSibling);
            revenuesExportBtn.addEventListener('click', function () {
                const revenueData = [['Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„', 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©']];
                let total = 0;
                for (let row of revenueTable.rows) {
                    if (row.cells.length >= 5) {
                        const amount = parseFloat(row.cells[0].textContent.trim()) || 0;
                        total += amount;
                        revenueData.push([
                            row.cells[0].textContent.trim(),
                            row.cells[1].textContent.trim(),
                            row.cells[2].textContent.trim(),
                            row.cells[3].textContent.trim(),
                            row.cells[4].textContent.trim()
                        ]);
                    }
                }
                revenueData.push(['', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:', total.toFixed(2) + ' Ø¬.Ù…']);
                const wb = XLSX.utils.book_new();
                const sheet = XLSX.utils.aoa_to_sheet(revenueData);
                XLSX.utils.book_append_sheet(wb, sheet, 'Revenues');
                XLSX.writeFile(wb, 'Ø§ÙŠØ±Ø§Ø¯Ø§Øª_Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.xlsx');
            });

            // ÙÙŠ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±
            const pettyExpensesLink = document.getElementById('sidebarPettyExpensesLink');
            pettyExpensesLink.style.display = 'block';

            // --- Live Search for Expenses Table ---
            const expenseSearchInput = document.getElementById('expenseSearchInput');
            const expensesTableBody = document.getElementById('projectExpensesTableBody');
            if (expenseSearchInput && expensesTableBody) {
                expenseSearchInput.addEventListener('input', function() {
                    const searchValue = this.value.trim().toLowerCase();
                    for (let row of expensesTableBody.rows) {
                        // Ignore the 'no data' row
                        if (row.cells.length < 6) continue;
                        let rowText = '';
                        for (let cell of row.cells) {
                            rowText += cell.textContent.trim().toLowerCase() + ' ';
                        }
                        if (rowText.includes(searchValue)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            }
        }) 
    </script>






















</body>

</html>