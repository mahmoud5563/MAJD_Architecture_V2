<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - MAJD Architecture</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #014C47;
            --primary-dark: #003a35;
            --secondary-bg: #e6e6e6;
            --text-color: #333;
            --light-text-color: #f4f4f4;
            --border-color: #ddd;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            direction: rtl;
            text-align: right;
        }

        /* Header Styling */
        .header {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .header .user-info {
            display: flex;
            align-items: center;
        }

        .header .user-info span {
            margin-right: 15px;
        }

        .header .logout-button {
            background-color: var(--primary-dark);
            color: var(--light-text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .header .logout-button:hover {
            background-color: #002b28;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--light-text-color);
            font-size: 24px;
            cursor: pointer;
        }

        /* Layout Container */
        .main-container {
            display: flex;
            flex: 1;
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: var(--light-text-color);
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 5px;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--light-text-color);
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .sidebar ul li a i {
            margin-left: 10px;
            font-size: 18px;
        }

        .sidebar ul li a:hover,
        .sidebar ul li.active a {
            background-color: var(--primary-dark);
            border-radius: 0 20px 20px 0;
        }

        /* Main Content Area */
        .content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-header h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 28px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card .icon {
            font-size: 45px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .card h2 {
            font-size: 22px;
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .card p {
            font-size: 18px;
            color: #555;
            margin: 0;
        }

        .card.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Modern backup buttons */
        #backupButtonsContainer {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            gap: 40px;
        }
        .backup-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 18px;
            border: none;
            border-radius: 22px;
            background: linear-gradient(90deg, #00bfae 0%, #014C47 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(1,76,71,0.10);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            margin-bottom: 0;
        }
        .backup-btn i {
            font-size: 22px;
        }
        .backup-btn:hover {
            background: linear-gradient(90deg, #014C47 0%, #00bfae 100%);
            transform: translateY(-2px) scale(1.04);
        }
        
        /* Password Modal Styles */
        .password-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .password-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .password-modal h3 {
            color: #014C47;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .password-modal input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        .password-modal input:focus {
            outline: none;
            border-color: #014C47;
        }
        .password-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .password-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .password-modal-btn.confirm {
            background-color: #014C47;
            color: white;
        }
        .password-modal-btn.cancel {
            background-color: #6c757d;
            color: white;
        }
        .password-modal-btn:hover {
            opacity: 0.8;
        }
        .password-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        @media (max-width: 600px) {
            #backupButtonsContainer {
                flex-direction: column;
                align-items: center;
                gap: 0;
            }
            .backup-btn {
                display: block;
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
                margin-bottom: 0;
            }
            #exportBackupBtn {
                margin-bottom: 24px !important;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header .user-info span {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                height: 100%;
                width: var(--sidebar-width);
                transform: translateX(100%);
                z-index: 999;
                box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
                padding-top: 70px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content-area {
                margin-right: 0;
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 998;
            }

            .overlay.active {
                display: block;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                /* Stack cards vertically on small screens */
            }
        }

        #dashboardMessage {
            position: fixed;
            
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            min-width: 260px;
            max-width: 90vw;
            padding: 18px 36px 18px 18px;
            border-radius: 12px;
            font-size: 18px;
            text-align: right;
            font-weight: bold;
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
            display: flex;
            align-items: flex-start;
            gap: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: pre-line;
            line-height: 1.4;
        }
        #dashboardMessage.active {
            opacity: 1;
            pointer-events: auto;
        }
        #dashboardMessage.success {
            background: #e6fff0;
            color: #137a3a;
            border: 1.5px solid #b2f2d7;
        }
        #dashboardMessage.error {
            background: #fff0f0;
            color: #b02a37;
            border: 1.5px solid #f5b2b2;
        }
        #dashboardMessage .msg-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
    </style>
</head>

<body>
    <div id="dashboardMessage" style="display:none;"></div>
    
    <!-- Password Modal for Import -->
    <div id="passwordModal" class="password-modal">
        <div class="password-modal-content">
            <h3>ğŸ”’ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h3>
            <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</p>
            <input type="password" id="importPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
            <div class="password-error" id="passwordError">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
            <div class="password-modal-buttons">
                <button class="password-modal-btn confirm" id="confirmPassword">ØªØ£ÙƒÙŠØ¯</button>
                <button class="password-modal-btn cancel" id="cancelPassword">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <div class="header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo">
            MAJD Architecture
        </div>
        <div class="user-info">
            <span id="loggedInUser"></span>
            <button class="logout-button" id="logoutButton">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="main-container">
        <div class="overlay" id="sidebarOverlay"></div>

        <div class="sidebar" id="sidebar">
            <ul>
                <li><a href="/dashboard.html" data-page="dashboard"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="/projects.html" data-page="projects"><i class="fas fa-project-diagram"></i> Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a></li>
                <li><a href="/clients.html" data-page="clients"><i class="fas fa-users"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
                <li><a href="/contractors.html" data-page="contractors"><i class="fas fa-hard-hat"></i> Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</a></li>
                <li><a href="/treasuries.html" data-page="treasuries"><i class="fas fa-boxes"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</a></li>
                <li><a href="/general-expenses.html" data-page="general-expenses"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a></li>
                <li><a href="/employees.html" data-page="employees"><i class="fas fa-user-tie"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</a></li>
                <li><a href="/users.html" data-page="users"><i class="fas fa-user-friends"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</a></li>
                <li><a href="/categories.html" data-page="categories"><i class="fas fa-tags"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</a></li>
                <li><a href="/warehouses.html" data-page="warehouses"><i class="fas fa-warehouse"></i> Ø§Ù„Ù…Ø®Ø§Ø²Ù†</a></li>
                <li><a href="/sales.html" data-page="sales"><i class="fas fa-shopping-cart"></i> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a></li>
                <li><a href="#" id="sidebarLogoutButton"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
                <li class="accounts-menu-parent">
                    <a href="#" onclick="toggleAccountsMenu(event)"><i class="fas fa-calculator"></i> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© <i class="fas fa-angle-down" style="margin-right:8px;"></i></a>
                    <ul class="accounts-submenu" style="display:none; background: #015c57; border-radius: 0 0 16px 0;">
                        <li><a href="/accounts-tree.html">Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a></li>
                        <li><a href="/add-journal-entry.html">Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠ</a></li>
                        <li><a href="/ledger.html">Ø¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø°</a></li>
                        <li><a href="/trial-balance.html">Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</a></li>
                        <li><a href="/income-statement.html">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</a></li>
                        <li><a href="/balance-sheet.html">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©</a></li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="content-area" id="contentArea">
            <div id="backupButtonsContainer" style="display:none; margin-bottom: 25px;">
                <button id="exportBackupBtn" class="backup-btn"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button id="importBackupBtn" class="backup-btn"><i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <input type="file" id="importBackupFile" accept="application/json" style="display:none;">
            </div>
            <div class="page-header">
                <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            </div>

            <div class="dashboard-grid">
                <!-- Project Summary Card -->
                <div class="card" id="projectsSummaryCard">
                    <div class="icon"><i class="fas fa-project-diagram"></i></div>
                    <h2>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹: <span id="totalProjects">0</span></p>
                    <p>Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¬Ø§Ø±ÙŠØ©: <span id="ongoingProjects">0</span></p>
                    <p>Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø©: <span id="completedProjects">0</span></p>
                </div>

                <!-- Clients Summary Card -->
                <div class="card" id="clientsSummaryCard">
                    <div class="icon"><i class="fas fa-users"></i></div>
                    <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span id="totalClients">0</span></p>
                </div>

                <!-- Treasury Balance Card -->
                <div class="card" id="treasuryBalanceCard">
                    <div class="icon"><i class="fas fa-cash-register"></i></div>
                    <h2>Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</h2>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯: <span id="totalTreasuryBalance">0.00</span> Ø¬.Ù…</p>
                </div>

                <!-- Expenses Card -->
                <div class="card" id="expensesCard">
                    <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
                    <h2>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <span id="totalExpenses">0.00</span> Ø¬.Ù…</p>
                </div>

                <!-- Revenue Card -->
                <div class="card" id="revenueCard">
                    <div class="icon"><i class="fas fa-chart-line"></i></div>
                    <h2>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h2>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: <span id="totalRevenue">0.00</span> Ø¬.Ù…</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "http://localhost:3000";

        // Client-side authentication check and redirection
        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const decodedPayload = decodeURIComponent(escape(window.atob(base64)));
                const payload = JSON.parse(decodedPayload);

                const username = payload.user.username || payload.user.id || 'Ù…Ø³ØªØ®Ø¯Ù…';
                let role = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                try {
                    role = payload.user.role || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                } catch (e) {
                    console.error("Failed to decode role:", e);
                }

                document.getElementById('loggedInUser').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${username} (${role})`;

                // Client-side authorization based on role for sidebar visibility
                const sidebar = document.getElementById('sidebar');
                const addProjectLink = sidebar.querySelector('[data-page="add-project"]');
                const usersLink = sidebar.querySelector('[data-page="users"]');
                const categoriesLink = sidebar.querySelector('[data-page="categories"]');
                const addTreasuryLink = sidebar.querySelector('[data-page="add-treasury"]');
                const treasuriesLink = sidebar.querySelector('[data-page="treasuries"]');
                const contractorsLink = sidebar.querySelector('[data-page="contractors"]');
                const clientsLink = sidebar.querySelector('[data-page="clients"]');
                const generalExpensesLink = sidebar.querySelector('[data-page="general-expenses"]');

                if (role === 'Ù…Ù‡Ù†Ø¯Ø³') {
                    // Hide restricted elements for engineer
                    if (addProjectLink) addProjectLink.style.display = 'none';
                    if (usersLink) usersLink.style.display = 'none';
                    if (addTreasuryLink) addTreasuryLink.style.display = 'none';
                    if (contractorsLink) contractorsLink.style.display = 'none';
                    if (clientsLink) clientsLink.style.display = 'none';
                    if (generalExpensesLink) generalExpensesLink.style.display = 'none';
                }

                // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹
                sidebar.querySelectorAll('li.active').forEach(li => li.classList.remove('active'));
                // Set active link in sidebar (for this page)
                const currentPageLink = document.querySelector(`.sidebar ul li a[data-page="dashboard"]`);
                if (currentPageLink) {
                    currentPageLink.parentElement.classList.add('active');
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø§Ùƒ Ø§Ø¨ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±
                if (role === 'Manager' || role === 'Ù…Ø¯ÙŠØ±') {
                    document.getElementById('backupButtonsContainer').style.display = 'block';
                }
            } catch (e) {
                console.error("Failed to decode token:", e);
                localStorage.removeItem('token');
                window.location.href = '/';
            }

            // Logout functionality
            const logout = () => {
                localStorage.removeItem('token');
                window.location.href = '/';
            };
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('sidebarLogoutButton').addEventListener('click', logout);

            // Responsive Sidebar Toggle
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                document.body.classList.toggle('sidebar-open');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.classList.remove('sidebar-open');
            });

            // ØªÙ†Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù…Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· Ø¹Ù„Ù‰ Ù„ÙŠÙ†Ùƒ
            sidebar.addEventListener('click', (event) => {
                const link = event.target.closest('a');
                if (link && link.href && link.id !== 'sidebarLogoutButton') {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                    // Ù…ÙÙŠØ´ preventDefaultØŒ ÙˆØ³ÙŠØ¨ Ø§Ù„ØªÙ†Ù‚Ù„ ÙŠØ´ØªØºÙ„ Ø¹Ø§Ø¯ÙŠ
                }
            });

            /* --- Dashboard Data Fetching --- */

            // Function to fetch project summary
            const fetchProjectSummary = async () => {
                const projectsSummaryCard = document.getElementById('projectsSummaryCard');
                projectsSummaryCard.classList.add('loading');
                try {
                    const response = await fetch(`${BASE_URL}/api/projects`, {
                        headers: {
                            'x-auth-token': localStorage.getItem('token')
                        }
                    });
                    const projects = await response.json();

                    if (response.ok) {
                        const total = projects.length;
                        const ongoing = projects.filter(p => p.status === 'Ø¬Ø§Ø±ÙŠ').length;
                        const completed = projects.filter(p => p.status === 'Ù…ÙƒØªÙ…Ù„').length;

                        document.getElementById('totalProjects').textContent = total;
                        document.getElementById('ongoingProjects').textContent = ongoing;
                        document.getElementById('completedProjects').textContent = completed;
                    } else {
                        console.error('Failed to fetch project summary:', projects.message);
                        document.getElementById('totalProjects').textContent = 'Ø®Ø·Ø£';
                    }
                } catch (error) {
                    console.error('Error fetching project summary:', error);
                    document.getElementById('totalProjects').textContent = 'Ø®Ø·Ø£';
                } finally {
                    projectsSummaryCard.classList.remove('loading');
                }
            };

            // Function to fetch client summary
            const fetchClientSummary = async () => {
                const clientsSummaryCard = document.getElementById('clientsSummaryCard');
                clientsSummaryCard.classList.add('loading');
                try {
                    const response = await fetch(`${BASE_URL}/api/clients`, {
                        headers: {
                            'x-auth-token': localStorage.getItem('token')
                        }
                    });
                    const clients = await response.json();

                    if (response.ok) {
                        const total = clients.length;
                        // Assuming all clients are "active" for now, or you can add a status field to Client model
                        document.getElementById('totalClients').textContent = total;
                    } else {
                        console.error('Failed to fetch client summary:', clients.message);
                        document.getElementById('totalClients').textContent = 'Ø®Ø·Ø£';
                    }
                } catch (error) {
                    console.error('Error fetching client summary:', error);
                    document.getElementById('totalClients').textContent = 'Ø®Ø·Ø£';
                } finally {
                    clientsSummaryCard.classList.remove('loading');
                }
            };

            // Function to fetch treasury balance
            const fetchTreasuryBalance = async () => {
                const treasuryBalanceCard = document.getElementById('treasuryBalanceCard');
                treasuryBalanceCard.classList.add('loading');
                try {
                    const response = await fetch(`${BASE_URL}/api/treasuries`, {
                        headers: {
                            'x-auth-token': localStorage.getItem('token')
                        }
                    });
                    const treasuries = await response.json();
                    if (response.ok) {
                        const totalBalance = treasuries.reduce((sum, t) => sum + (t.currentBalance || 0), 0);
                        document.getElementById('totalTreasuryBalance').textContent = totalBalance.toFixed(2);
                    } else {
                        document.getElementById('totalTreasuryBalance').textContent = 'Ø®Ø·Ø£';
                    }
                } catch (error) {
                    document.getElementById('totalTreasuryBalance').textContent = 'Ø®Ø·Ø£';
                } finally {
                    treasuryBalanceCard.classList.remove('loading');
                }
            };

            // Function to fetch total expenses (project + general)
            const fetchTotalExpenses = async () => {
                const expensesCard = document.getElementById('expensesCard');
                expensesCard.classList.add('loading');
                try {
                    // 1. Get project expenses (transactions of type 'Ù…ØµØ±ÙˆÙ')
                    const transRes = await fetch(`${BASE_URL}/api/transactions?type=Ù…ØµØ±ÙˆÙ`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const transactions = await transRes.json();
                    let projectExpenses = 0;
                    if (transRes.ok && Array.isArray(transactions)) {
                        projectExpenses = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                    }
                    // 2. Get general expenses
                    const genRes = await fetch(`${BASE_URL}/api/general-expenses/total`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const genData = await genRes.json();
                    let generalExpenses = 0;
                    if (genRes.ok && genData && typeof genData.total === 'number') {
                        generalExpenses = genData.total;
                    }
                    // 3. Sum and display
                    const total = projectExpenses + generalExpenses;
                    document.getElementById('totalExpenses').textContent = total.toFixed(2);
                } catch (error) {
                    document.getElementById('totalExpenses').textContent = 'Ø®Ø·Ø£';
                } finally {
                    expensesCard.classList.remove('loading');
                }
            };

            // Function to fetch total revenue
            const fetchTotalRevenue = async () => {
                const revenueCard = document.getElementById('revenueCard');
                revenueCard.classList.add('loading');
                try {
                    // Get revenue from transactions of type 'Ø¥ÙŠØ¯Ø§Ø¹'
                    const response = await fetch(`${BASE_URL}/api/transactions?type=Ø¥ÙŠØ¯Ø§Ø¹`, {
                        headers: { 'x-auth-token': localStorage.getItem('token') }
                    });
                    const transactions = await response.json();
                    if (response.ok && Array.isArray(transactions)) {
                        const totalRevenue = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                        document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
                    } else {
                        document.getElementById('totalRevenue').textContent = 'Ø®Ø·Ø£';
                    }
                } catch (error) {
                    document.getElementById('totalRevenue').textContent = 'Ø®Ø·Ø£';
                } finally {
                    revenueCard.classList.remove('loading');
                }
            };

            // Call all summary functions on page load
            fetchProjectSummary();
            fetchClientSummary();
            fetchTreasuryBalance();
            fetchTotalExpenses();
            fetchTotalRevenue();
            
            // Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const exportBackupBtn = document.getElementById('exportBackupBtn');
            if (exportBackupBtn) {
                exportBackupBtn.addEventListener('click', async function() {
                    exportBackupBtn.disabled = true;
                    exportBackupBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
                    try {
                        const res = await fetch(`${BASE_URL}/api/backup/export`, {
                            headers: { 'x-auth-token': token }
                        });
                        if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
                        const data = await res.json();
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'backup.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showDashboardMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success', 2000);
                    } catch (err) {
                        showDashboardMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ' + err.message, 'error', 2500);
                    } finally {
                        exportBackupBtn.disabled = false;
                        exportBackupBtn.textContent = 'ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©';
                    }
                });
            }

            // Ø²Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            const importBackupBtn = document.getElementById('importBackupBtn');
            const importBackupFile = document.getElementById('importBackupFile');
            const passwordModal = document.getElementById('passwordModal');
            const importPassword = document.getElementById('importPassword');
            const confirmPassword = document.getElementById('confirmPassword');
            const cancelPassword = document.getElementById('cancelPassword');
            const passwordError = document.getElementById('passwordError');
            
            // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§)
            const IMPORT_PASSWORD = 'majd2025';
            
            if (importBackupBtn && importBackupFile) {
                importBackupBtn.addEventListener('click', function() {
                    passwordModal.style.display = 'block';
                    importPassword.focus();
                });
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
                cancelPassword.addEventListener('click', function() {
                    passwordModal.style.display = 'none';
                    importPassword.value = '';
                    passwordError.style.display = 'none';
                });
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
                passwordModal.addEventListener('click', function(e) {
                    if (e.target === passwordModal) {
                        passwordModal.style.display = 'none';
                        importPassword.value = '';
                        passwordError.style.display = 'none';
                    }
                });
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                confirmPassword.addEventListener('click', function() {
                    if (importPassword.value === IMPORT_PASSWORD) {
                        passwordModal.style.display = 'none';
                        importPassword.value = '';
                        passwordError.style.display = 'none';
                        importBackupFile.value = '';
                        importBackupFile.click();
                    } else {
                        passwordError.style.display = 'block';
                        importPassword.value = '';
                        importPassword.focus();
                    }
                });
                
                // Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
                importPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmPassword.click();
                    }
                });
                
                importBackupFile.addEventListener('change', function() {
                    if (!importBackupFile.files.length) return;
                    if (!confirm('ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³ÙŠØ­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆÙŠØ³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
                    const file = importBackupFile.files[0];
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            importBackupBtn.disabled = true;
                            importBackupBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...';
                            const json = JSON.parse(e.target.result);
                            const res = await fetch(`${BASE_URL}/api/backup/import`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'x-auth-token': token
                                },
                                body: JSON.stringify(json)
                            });
                            const result = await res.json();
                            if (res.ok) {
                                showDashboardMessage('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success', 2000);
                                setTimeout(() => window.location.reload(), 2000);
                            } else {
                                let errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©';
                                if (result.error) {
                                    errorMessage += ': ' + result.error;
                                }
                                if (result.details) {
                                    errorMessage += '\n' + result.details;
                                }
                                showDashboardMessage(errorMessage, 'error', 5000);
                            }
                        } catch (err) {
                            showDashboardMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ' + err.message, 'error', 5000);
                        } finally {
                            importBackupBtn.disabled = false;
                            importBackupBtn.textContent = 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©';
                        }
                    };
                    reader.readAsText(file);
                });
            }
        });

        function showDashboardMessage(message, type = 'success', duration = 2000) {
            const msgDiv = document.getElementById('dashboardMessage');
            let icon = type === 'success'
                ? '<span class="msg-icon">âœ…</span>'
                : '<span class="msg-icon">âŒ</span>';
            msgDiv.innerHTML = icon + '<span>' + message + '</span>';
            msgDiv.className = type + ' active';
            msgDiv.style.display = 'flex';
            setTimeout(() => {
                msgDiv.classList.remove('active');
                setTimeout(() => { msgDiv.style.display = 'none'; }, 400);
            }, duration);
        }

        function toggleAccountsMenu(event) {
            event.preventDefault();
            var submenu = document.querySelector('.accounts-submenu');
            if (submenu) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
</body>

</html>